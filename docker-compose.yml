version: "3.1"
services:
  gateway:
    restart: always
    build:
      dockerfile: Dockerfile.dev
      context: ./gateway
    command: /bin/bash -c "envsubst '$${DOMAIN_NAME}' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && rm /etc/nginx/conf.d/default.conf.template && exec nginx -g 'daemon off;'"
    ports:
      - 80:80
    depends_on:
      - api
      - analytics
      - resolver
      - client
    environment:
      DOMAIN_NAME: localhost
  cache:
    image: redis
    restart: always
  db:
    image: bitnami/mongodb
    restart: always
    volumes:
      - data:/bitnami
    user: root
    ports:
      - 27017:27017
  client:
    build:
      dockerfile: Dockerfile.dev
      context: ./client
    volumes:
      - ./client:/code
    environment:
      REACT_APP_DOMAIN_NAME: localhost
    depends_on:
      - api
      - analytics
  api:
    restart: always
    build:
      dockerfile: Dockerfile.dev
      context: ./api
    volumes:
      - ./api:/code
    secrets:
      - api_port
      - db_url
      - redis_url
    environment:
      PORT_FILE: /run/secrets/api_port
      MONGODB_URL_FILE: /run/secrets/db_url
      REDIS_URL_FILE: /run/secrets/redis_url
    depends_on:
      - db
      - cache
  analytics:
    restart: always
    build:
      dockerfile: Dockerfile.dev
      context: ./analytics
    volumes:
      - ./analytics:/code
    secrets:
      - api_port
      - db_url
    environment:
      PORT_FILE: /run/secrets/api_port
      MONGODB_URL_FILE: /run/secrets/db_url
    depends_on:
      - db
  resolver:
    restart: always
    depends_on:
      - api
      - analytics
    build:
      dockerfile: Dockerfile.dev
      context: ./resolver
    environment:
      DOMAIN_NAME: localhost
    # volumes:
    #   - ./resolver/src:/usr/share/nginx/html/
    command: /bin/bash -c "envsubst '$${DOMAIN_NAME}' < /usr/share/nginx/html/index.html.template > /usr/share/nginx/html/index.html && exec nginx -g 'daemon off;'"
secrets:
  db_url:
    file: ./secrets/db_url.txt
  api_port:
    file: ./secrets/api_port.txt
  redis_url:
    file: ./secrets/redis_url.txt

volumes:
  data:
